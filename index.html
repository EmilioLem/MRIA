<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Machine Recognition Image Analyser</title>
  <style>
    #canvas, #vidMos{
      display: none;
    }
    *{
      font-size: 1rem;
      background: black;
      color: white;
      text-align: center;
    }
    .optgr{
      color: black;
      background: white;
    }
  </style>
</head>

<body>
  <h3>Resolución actual: <span id="currentResolution"></span></h3>
  <h3>Fotogramas por segundo: <span id="currentFPS"></span> fps</h3>

  <p>Margen de error para diferenciar cambio de color: <input id="marErCol" type="number" value="25"> (En filtros de <b>movimiento</b>)</p>

  <p><u>Tipo de filtro:</u> <select id="typeFil">
    <ul>
      <option value="l"><li>Luminosidad</li></option>
      <option value="o"><li>Original</li></option>
      <!-- Cool -->
      <optgroup label="Movimiento:" class="optgr">
        <option value="mig"><li>Invertir general</li></option>
        <option value="mip"><li>Invertir particular</li></option>
        <option value="msg"><li>Sólo general</li></option>
        <option value="msp" selected><li>Sólo particular</li></option>
      </optgroup>
      <!-- El general busca el cambio de píxeles de los 3 canales, el particular se fija y altera cada canal por separado -->
      <optgroup label="Mostrar canales:" class="optgr">
        <option value="r"><li>Canal R</li></option>
        <option value="g"><li>Canal G</li></option>
        <option value="b"><li>Canal B</li></option>
        <option value="rg"><li>Canales rg</li></option>
        <option value="gb"><li>Canales gb</li></option>
        <option value="rb"><li>Canales rb</li></option>
      </optgroup>
    </ul>
  </select></p>

  <input type="checkbox" id="resalMovi">Radio button sin uso hasta ahora<br><br>
  
  <div id="vidMos" class="vidRela">
    <button id="vidOcuBut">Ocultar video original</button>
    <h2>Video original:</h2>
    <video autoplay id="video"></video>
  </div>
  <div id="vidOcu" class="vidRela">
    <button id="vidMosBut">Mostrar video original</button>
  </div>

  
  <canvas id="canvas"></canvas>
  <h2>Alterado:</h2>
  <canvas id="canvasRGB"></canvas>

  <script>
    var row = [];
    var data, dataRe; //dataUx
    const canvas = document.querySelector('#canvas');
    let context = canvas.getContext('2d');

    const canvasRGB = document.querySelector('#canvasRGB');
    let contextRGB = canvasRGB.getContext('2d');

    var marErCol = document.getElementById("marErCol");
    var typeFil = document.getElementById("typeFil");

    vidMos = document.getElementById("vidMos");
    vidOcu = document.getElementById("vidOcu");
  
    var x=0;
    var y=0;
    var listo = false;

    const video = document.querySelector('#video');
    const constraints = {
      video: {
        //16:9 aspect ratio
        /*width: {
         ideal: 640//320//256
         /*min: 1280,
         ideal: 1920,
         max: 2560,*
       },
       height: {
         ideal: 480//240//144
         /*min: 720,
         ideal: 1080,
         max: 1440,*
       },*/
        //facingMode: "enviroment"
      },
    };

    function sleep(ms) {
     return new Promise(resolve => setTimeout(resolve, ms));
    }

    window.onload = async function startVideo() {
      const videoStream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = videoStream;      
      do{
        x = video.videoWidth;
        y = video.videoHeight;
        await sleep(20);
      }
      while(x == 0 || y == 0);
      canvasRGB.width = canvas.width = x;
      canvasRGB.height = canvas.height = y;
      document.getElementById("currentResolution").innerText = `${x} x ${y}`;
      await sleep(1000);
      context.drawImage(video, 0, 0);
      dataRe = context.getImageData(0, 0, x, y).data;
      await sleep(35);
      setInterval(getPixel, 66.66);//130);//33.33);
    };

    function getPixel() {
      const iniTime = Date.now();
      context.drawImage(video, 0, 0);
      data = context.getImageData(0, 0, x, y).data; //Executed in 3.15 ms average.
      let colRed = marErCol.value;
      let actTypeFil = typeFil.value;
      const toDlong = data.length;
      var pl=0;

      /*if (dataRe == undefined) {  //Sustituído en startVideo()
        dataRe = data; //context.getImageData(0, 0, x, y).data;
        console.timeEnd("Total");
        return;
      }*/

      for (let i = 1; i <= toDlong / 4; i++) {
        switch (actTypeFil) {
          case 'l':
            let pi = (dataRe[i * 4 - 4] + dataRe[i * 4 - 3] + dataRe[i * 4 - 2]) / 3;
            dataRe[i * 4 - 4] = dataRe[i * 4 - 3] = dataRe[i * 4 - 2] = pi;
          break;  //Tomar luminosidad

          case 'o': break;

          case 'mip':
            for(let j=4; j>1; j--){ //Analyses RGB values
              let anteP = dataRe[i * 4 - j]; //Píxel antíguo
              let actuP = data[i * 4 - j];  //Píxel actual
              if(anteP - colRed > actuP || anteP + colRed < actuP){
                dataRe[i * 4 - j] = 255 - actuP;
                pl++;
              }
            }
          break;

          /*case 'mig':
            let pg = 0;
            let antePr = dataRe[i * 4 - 4];
            let antePg = dataRe[i * 4 - 3];
            let antePb = dataRe[i * 4 - 2];
            let actuPr = data[i * 4 - 4];
            let actuPg = data[i * 4 - 3];
            let actuPb = data[i * 4 - 2];
            //if(antePr - colRed > actuPr)...

            if( dataRe[]) //Si todas esas condiciones son negativas, hacer algo.
            //

            for (let j = 4; j > 1; j--) { //Analyses RGB values
              let anteP = dataRe[i * 4 - j]; //Píxel antíguo
              let actuP = data[i * 4 - j];  //Píxel actual
              if (anteP - colRed > actuP || anteP + colRed < actuP) {
                dataRe[i * 4 - j] = 0; //255 - actuP;
                pl++;
              }
            }
          break;*/

          case 'msp':
            for (let j = 4; j > 1; j--) { //Analyses RGB values
              let anteP = dataRe[i * 4 - j]; //Píxel antíguo
              let actuP = data[i * 4 - j];  //Píxel actual
              if (anteP - colRed > actuP || anteP + colRed < actuP) {
                //Actualy nothing happens    255 - actuP;
                pl++;
              }else{
                dataRe[i * 4 - j] = 0;
              }
            }
            break;

          case 'r':
            dataRe[i * 4 - 3] = 0;
            dataRe[i * 4 - 2] = 0;
          break;

          case 'g':
            dataRe[i * 4 - 4] = 0;
            dataRe[i * 4 - 2] = 0;
          break;

          case 'b':
            dataRe[i * 4 - 4] = 0;
            dataRe[i * 4 - 3] = 0;
          break;

          case 'rg':
            dataRe[i * 4 - 2] = 0;
          break;

          case 'rb':
            dataRe[i * 4 - 3] = 0;
          break;

          case 'gb':
            dataRe[i * 4 - 4] = 0;
          break;

          default:
            dataRe[i * 4 - 4] = dataRe[i * 4 - 3] = dataRe[i * 4 - 2] = 0;
          break;
        };

      }

      var aDisplay = contextRGB.createImageData(x, y);
      var aData = aDisplay.data;
      for (let i = 0; i < toDlong; i++) {
        aData[i] = dataRe[i];
      }
      contextRGB.putImageData(aDisplay, 0, 0);

      dataRe = data;
      const finTime = Date.now();
      document.getElementById("currentFPS").innerText = `${Math.round(10000/(finTime-iniTime))/10}`;
      console.log(pl);
    };

    document.getElementById("vidMosBut").addEventListener("click", function(){
      vidOcu.style.display = "none";
      vidMos.style.display = "initial";
    });
    document.getElementById("vidOcuBut").addEventListener("click", function () {
        vidMos.style.display = "none";
        vidOcu.style.display = "initial";
      });

/*
////////////////////////
  
   
////////////////
       Los píxeles de la imagen se leen y esciben de izquierda a derecha, y progresivamente hacia abajo. 
        
/////////////
   
*/

  </script>
</body>

</html>
