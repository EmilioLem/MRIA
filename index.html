<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video?</title>
  <style>
    #canvas{
      display: none;
    }
    *{
      font-size: 1rem;
    }
    button{
      font-size: 1.3rem;
      color: saddlebrown;
      font-weight: bold;
    }
    /**/
  </style>
</head>

<body>
  <h3><span id="currentResolution"></span> current resolution</h3>
  <p>Margen de error para diferenciar cambio de color: <input id="marErCol" type="number" value="20"> (Por ahora no utilizado)</p>
  <!-- <p>Tipo de filtro: <input type="text" id="typeFil" placeholder="l, r, g, b" value="g"></p><br> -->
  <p>Tipo de filtro: <select id="typeFil">
    <ul>
      <option value="l"><li>Luminosidad</li></option>
      <option value="r"><li>Canal R</li></option>
      <option value="g"><li>Canal G</li></option>
      <option value="b"><li>Canal B</li></option>
    </ul>
  </select></p><br>

  
  <button onclick="setInterval(getPixel, 33.33);">clickeame!!!</button> <br>

  <video autoplay id="video"></video>
  <canvas id="canvas"></canvas>
  <canvas id="canvasRGB"></canvas>

  <script>
    var row = [];
    var data, dataUx, dataRe;
    const canvas = document.querySelector('#canvas');
    let context = canvas.getContext('2d');

    const canvasRGB = document.querySelector('#canvasRGB');
    let contextRGB = canvasRGB.getContext('2d');

    var marErCol = document.getElementById("marErCol");
    var typeFil = document.getElementById("typeFil");

    const video = document.querySelector('#video');
    const constraints = {
      video: {
        //16:9 aspect ratio
        /*width: {
         ideal: 640//320//256
         /*min: 1280,
         ideal: 1920,
         max: 2560,*
       },
       height: {
         ideal: 480//240//144
         /*min: 720,
         ideal: 1080,
         max: 1440,*
       },*/
        //facingMode: "enviroment"
      },
    };

    window.onload = startVideo();
    setInterval(getPixel, 40);

    async function startVideo() {
      const videoStream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = videoStream;
    };

    

    function scre() {  //Executed in 0.13 ms average.
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvasRGB.width = canvas.width;
      canvasRGB.height = canvas.height;
      document.getElementById("currentResolution").innerText = `${canvas.width} x ${canvas.height}`;
      if (canvas.width == 0 || canvas.height == 0) {
        return false;
      } else {
        context.drawImage(video, 0, 0);
        return true;
      }
    };
    function getPixel() {
      console.time("Total");
      if (scre()) {
        var x = canvas.width;
        var y = canvas.height;
        var k = 0;
        data = context.getImageData(0, 0, x, y).data; //Executed in 3.15 ms average.

        if (dataRe == undefined) {
          dataRe = data;
          console.timeEnd("Total");
          return;
        }
        dataUx = data;
        let colRed = marErCol.value;
        let actTypeFil = typeFil.value;

        for (let i = 1; i <= data.length/4; i++){
          let pi;
          switch(actTypeFil){
            case 'l': 
              pi = (data[i * 4 - 4] + data[i * 4 - 3] + data[i * 4 - 2]) / 3;
              data[i * 4 - 4] = data[i * 4 - 3] = data[i * 4 - 2] = pi;
            break;  //Tomar luminosidad
              
            case 'r':
              data[i * 4 - 3] = 0;
              data[i * 4 - 2] = 0;
            break;

            case 'g':
              data[i * 4 - 4] = 0;
              data[i * 4 - 2] = 0;
            break;

            case 'b':
              data[i * 4 - 4] = 0;
              data[i * 4 - 3] = 0;
            break;

            default: 
              data[i * 4 - 4] = data[i * 4 - 3] = data[i * 4 - 2] = 0;
              break;
          };
          
        }

        /*for (let i = 0; i < data.length; i++) { //invierte raros
          if (i % 4 != 3) {
            if (dataRe[i] - colRed > data[i] || dataRe[i] + colRed < data[i]) {
              data[i] = 255 - data[i]; //Sólo si hay gran cambio de color
            }
          }
        }*/
        drawData(x, y);
        dataRe = dataUx;
      };
      console.timeEnd("Total");
    };

    function drawData(xx, yy) {
      var aDisplay = contextRGB.createImageData(xx, yy);
      var aData = aDisplay.data;

      for (let i = 0; i < aData.length; i++) {
        aData[i] = data[i];
      }
      contextRGB.putImageData(aDisplay, 0, 0);
    };

    /*    ////////////////////////
   
      for (let i = 1; i <= 1280; i++) { //Descubrir orden de array uni-dimensional
         let sti = `rgb(${data[i * 4 - 4]}, ${data[i * 4 - 3]}, ${data[i * 4 - 2]})`;
         console.log(`%c${i}`, `color: ${sti}`);
       };
   
     ////////////////
       Los píxeles de la imagen se leen y esciben de izquierda a derecha, y progresivamente hacia abajo. 
        
        document.querySelector("body").style.backgroundColor = `rgb(${data[(640 * 239 + 320) * 4 - 4]}, ${data[(640 * 239 + 320) * 4 - 3]}, ${data[(640 * 239 + 320) * 4 - 2]})`;
       /////////////
   
     */

  </script>
</body>

</html>
