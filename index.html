<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Machine Recognition Image Analyser</title>
  <style>
    #canvas, #vidMos{
      display: none;
    }
    *{
      font-size: 1rem;
      background: black;
      color: white;
      text-align: center;
    }
    .optgr{
      color: black;
      background: white;
    }
    /*button{
      font-size: 1.3rem;
      color: saddlebrown;
      font-weight: bold;
    }
    */
  </style>
</head>

<body>
  <h3><span id="currentResolution"></span> current resolution</h3>

  <p>Margen de error para diferenciar cambio de color: <input id="marErCol" type="number" value="20"> (Por ahora no utilizado)</p>

  <p><u>Tipo de filtro:</u> <select id="typeFil">
    <ul>
      <option value="l"><li>Luminosidad</li></option>
      <option value="o"><li>Original</li></option>
      <optgroup label="Movimiento:" class="optgr">
        <option value="mig"><li>Invertir general</li></option>
        <option value="mip"><li>Invertir particular</li></option>
        <option value="msg"><li>Sólo general</li></option>
        <option value="msp"><li>Sólo particular</li></option>
      </optgroup>
      <!-- El general busca el cambio de píxeles de los 3 canales, el particular se fija y altera cada canal por separado -->
      <optgroup label="Mostrar canales:" class="optgr">
        <option value="r"><li>Canal R</li></option>
        <option value="b"><li>Canal B</li></option>
        <option value="g"><li>Canal G</li></option>
        <option value="rb"><li>Canales rb</li></option>
        <option value="rg"><li>Canales rg</li></option>
        <option value="gb"><li>Canales gb</li></option>
      </optgroup>
    </ul>
  </select></p>

  <input type="checkbox" id="resalMovi">Radio button sin uso hasta ahora<br><br>
  
  <div id="vidMos" class="vidRela">
    <button id="vidOcuBut">Ocultar video original</button>
    <h2>Video original:</h2>
    <video autoplay id="video"></video>
  </div>
  <div id="vidOcu" class="vidRela">
    <button id="vidMosBut">Mostrar video original</button>
  </div>

  
  <canvas id="canvas"></canvas>
  <h2>Alterado:</h2>
  <canvas id="canvasRGB"></canvas>

  <!-- <br><button onclick="setInterval(getPixel, 40)">Presione sólo si no inicia el video automáticamente</button> -->

  <script>
    var row = [];
    var data, dataUx, dataRe;
    const canvas = document.querySelector('#canvas');
    let context = canvas.getContext('2d');

    const canvasRGB = document.querySelector('#canvasRGB');
    let contextRGB = canvasRGB.getContext('2d');

    var marErCol = document.getElementById("marErCol");
    var typeFil = document.getElementById("typeFil");

    vidMos = document.getElementById("vidMos");
    vidOcu = document.getElementById("vidOcu");
    function ajuVideo(){
      //ifvidMos
    }

    const video = document.querySelector('#video');
    const constraints = {
      video: {
        //16:9 aspect ratio
        /*width: {
         ideal: 640//320//256
         /*min: 1280,
         ideal: 1920,
         max: 2560,*
       },
       height: {
         ideal: 480//240//144
         /*min: 720,
         ideal: 1080,
         max: 1440,*
       },*/
        //facingMode: "enviroment"
      },
    };

    window.onload = startVideo();
    setInterval(getPixel, 40);

    async function startVideo() {
      const videoStream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = videoStream;
    };

    

    function scre() {  //Executed in 0.13 ms average.
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvasRGB.width = canvas.width;
      canvasRGB.height = canvas.height;
      document.getElementById("currentResolution").innerText = `${canvas.width} x ${canvas.height}`;
      if (canvas.width == 0 || canvas.height == 0) {
        return false;
      } else {
        context.drawImage(video, 0, 0);
        return true;
      }
    };
    function getPixel() {
      console.time("Total");
      if (scre()) {
        var x = canvas.width;
        var y = canvas.height;
        var k = 0;
        data = context.getImageData(0, 0, x, y).data; //Executed in 3.15 ms average.

        if (dataRe == undefined) {
          dataRe = data;
          console.timeEnd("Total");
          return;
        }
        dataUx = data;
        let colRed = marErCol.value;
        let actTypeFil = typeFil.value;

        for (let i = 1; i <= data.length/4; i++){
          let pi;
          switch(actTypeFil){
            case 'l': 
              pi = (data[i * 4 - 4] + data[i * 4 - 3] + data[i * 4 - 2]) / 3;
              data[i * 4 - 4] = data[i * 4 - 3] = data[i * 4 - 2] = pi;
            break;  //Tomar luminosidad

            case 'o': break;

            case 'img': 
              if(dataRe[i-4] - colRed > data[i-4] || 
                  dataRe[i-4] + colRed < data[i-4])

              /*for (let i = 0; i < data.length; i++) { //invierte raros
                 if (i % 4 != 3) {
                   if (dataRe[i] - colRed > data[i] || dataRe[i] + colRed < data[i]) {
                    data[i] = 255 - data[i]; //Sólo si hay gran cambio de color
                  }
                }
              }*/
            break;
              
            case 'r':
              data[i * 4 - 3] = 0;
              data[i * 4 - 2] = 0;
            break;

            case 'g':
              data[i * 4 - 4] = 0;
              data[i * 4 - 2] = 0;
            break;

            case 'b':
              data[i * 4 - 4] = 0;
              data[i * 4 - 3] = 0;
            break;

            case 'rg':
              data[i * 4 - 2] = 0;
              break;

            case 'rb':
              data[i * 4 - 3] = 0;
              break;

            case 'gb':
              data[i * 4 - 4] = 0;
              break;

            default: 
              data[i * 4 - 4] = data[i * 4 - 3] = data[i * 4 - 2] = 0;
              break;
          };
          
        }
        drawData(x, y);
        dataRe = dataUx;
      };
      console.timeEnd("Total");
    };

    function drawData(xx, yy) {
      var aDisplay = contextRGB.createImageData(xx, yy);
      var aData = aDisplay.data;

      for (let i = 0; i < aData.length; i++) {
        aData[i] = data[i];
      }
      contextRGB.putImageData(aDisplay, 0, 0);
    };

    document.getElementById("vidMosBut").addEventListener("click", function(){
      vidOcu.style.display = "none";
      vidMos.style.display = "initial";
    });
    document.getElementById("vidOcuBut").addEventListener("click", function () {
        vidMos.style.display = "none";
        vidOcu.style.display = "initial";
      });

    /*    
    Habilitar modo _resaltar reciente_

    No puedo ocular vidMos
    
    ////////////////////////
   
      for (let i = 1; i <= 1280; i++) { //Descubrir orden de array uni-dimensional
         let sti = `rgb(${data[i * 4 - 4]}, ${data[i * 4 - 3]}, ${data[i * 4 - 2]})`;
         console.log(`%c${i}`, `color: ${sti}`);
       };
   
     ////////////////
       Los píxeles de la imagen se leen y esciben de izquierda a derecha, y progresivamente hacia abajo. 
        
        document.querySelector("body").style.backgroundColor = `rgb(${data[(640 * 239 + 320) * 4 - 4]}, ${data[(640 * 239 + 320) * 4 - 3]}, ${data[(640 * 239 + 320) * 4 - 2]})`;
       /////////////
   
     */

  </script>
</body>

</html>
